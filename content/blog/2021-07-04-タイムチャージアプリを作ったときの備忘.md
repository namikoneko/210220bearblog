---
title: タイムチャージアプリを作ったときの備忘
slug: maiking-timecharge-application
date: 2021-07-04T14:10:35.246Z
description: タイムチャージアプリを作ったときの備忘です。
tags:
  - app
---
### github

<https://github.com/namikoneko/210702charge>

### db



postテーブル1つだけ使っている

### 苦労したところ

startの時刻とendの時刻の差を取るのに，意外と苦労した


find_arrayで$rowsにデータを取ると，差を，$rowsに入れ直すことができなかった

find_manyだと，入れ直すことができた


しかし，unix time（大きい桁の秒数）にすると，人がupdateで触ることはできなくなる


"YYYY-MM-DD"の文字列に，どこでするのかも課題だった（最終的に解決した）


一方，"YYYY-MM-DD"という形式だと，どこで引き算するかが問題になる

PHPでやるとすると，Yの部分を取って，M，Dの部分を取って・・・となって，面倒になる


sqliteの方で，日付文字列同士で引き算できるのか試したが，うまくできなかった


結局，以下となった


- DBにはunix timeを入れる
- "YYYY-MM-DD"の文字列には，生のSQLを書いて，ここで時間の文字列にする。早めに時間文字列にしておくと，複数パターンで表示させる場合（allと特定のtitle）PHPで複数の変換を書かないで済む（SQLで書いているわけだが）
- PHPでは，unix time同士の差を，60で割って分表示にするところだけやっている


限定なしのすべての表示と，特定title限定の表示を作りたくなった


ほとんど同じテンプレートを2回書きたくなかったので，同じposts.tplに流し込むようにした

$titleをフラグとして持つようにした。すべての表示の場合，"all"の固定文字列をプログラムの中で持たせた


updateフォーム（テンプレート）へ, updateフォームからの戻り, 

copy, start, endなど，すべての遷移について，$titleを持っていって場合分けした


titleにaタグをつけて，ワンクリックでtitleで絞り込めるように工夫した


集計も必須なので付けた。ひとまず，特定titleの集計のみとした


titleが集計の基礎，基準なので，1レコードだけupdateしてはいけない，手動で複数レコードを同じ文字列に変更するのは面倒


本当は，別テーブルにしてリレーションさせるのがいいと思うが，複数レコードを絞り込んで一括でupdateする仕様にした


apiにしなかったので，開発が早かったのか，ページングまでつけることができた


スラスラわかるPHPのページングは，1, 2, 3・・・とページのリンクを作る方法だということに気づいた


前へ，後へ，という先後のページングの方が，ifで場合分けして表示，非表示を考えるので，面倒だった


検索をまだつけていない


当初，集計の対象者（title）は，別テーブルに記録しようと思っていた


今後，このようにしてもいい


特にページングの関係で，DBの全行数や，1ページのレコード数や，現在のページ数など，smartyのassignで，多くの値を持たせるようになった


smartyの連想配列で，短い行でまとめて持たせるとコードがすっきりするかもしれない


<https://www.smarty.net/docs/ja/api.assign.tpl>